version: '3.5'

services:
  # Applications
  heimdallr:
    build:
      args:
        app_name: heimdallr
      context: .
      dockerfile: images/node/Dockerfile
      target: application
    container_name: heimdallr
    depends_on:
      - valhalla
    entrypoint: "yarn start:heimdallr"
    image: yggdrasil/heimdallr
    networks:
      - yggdrasil
      - midgard
    ports:
      - "3000:3000"
    volumes:
      - ./node_modules:/usr/app/node_modules:delegated
      - ./apps/heimdallr:/usr/app/apps/heimdallr:delegated
      - ./libs:/usr/app/libs:delegated

  valhalla:
    build:
      args:
        app_name: valhalla
      context: .
      dockerfile: images/node/Dockerfile
      target: application
    container_name: valhalla
    depends_on:
      - valhalla_db
    entrypoint: "yarn start:valhalla"
    image: yggdrasil/valhalla
    networks:
      - yggdrasil
    ports:
      - "3000"
    volumes:
      - ./node_modules:/usr/app/node_modules:delegated
      - ./apps/valhalla:/usr/app/apps/valhalla:delegated
      - ./libs:/usr/app/libs:delegated

  # Databases
  valhalla_db:
    container_name: valhalla_db
    image: postgres:12-alpine
    environment:
      POSTGRES_DB: valhalla
      POSTGRES_PASSWORD: password
      POSTGRES_USER: admin
    networks:
      - yggdrasil
      - midgard
    ports:
      - "5433:5432"

networks:
  yggdrasil:
    internal: true
    name: yggdrasil
  midgard:
    name: midgard
