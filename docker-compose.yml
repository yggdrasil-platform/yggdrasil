version: '3.5'

services:
  # Applications
  heimdallr:
    build:
      args:
        app_name: heimdallr
      context: .
      dockerfile: images/node/Dockerfile
      target: application
    container_name: heimdallr
    depends_on:
      - mimir
      - valhalla
    entrypoint: "yarn start:heimdallr"
    image: yggdrasil/heimdallr
    networks:
      - yggdrasil
      - midgard
    ports:
      - "3000:3000"
    volumes:
      - ./node_modules:/usr/app/node_modules:delegated
      - ./apps/heimdallr:/usr/app/apps/heimdallr:delegated
      - ./libs:/usr/app/libs:delegated

  mimir:
    build:
      args:
        app_name: mimir
      context: .
      dockerfile: images/node/Dockerfile
      target: application
    container_name: mimir
    depends_on:
      - db
    entrypoint: "yarn start:mimir"
    image: yggdrasil/mimir
    networks:
      - yggdrasil
    ports:
      - "3000"
    volumes:
      - ./node_modules:/usr/app/node_modules:delegated
      - ./apps/mimir:/usr/app/apps/mimir:delegated
      - ./libs:/usr/app/libs:delegated

  valhalla:
    build:
      args:
        app_name: valhalla
      context: .
      dockerfile: images/node/Dockerfile
      target: application
    container_name: valhalla
    depends_on:
      - db
    entrypoint: "yarn start:valhalla"
    image: yggdrasil/valhalla
    networks:
      - yggdrasil
    ports:
      - "3000"
    volumes:
      - ./node_modules:/usr/app/node_modules:delegated
      - ./apps/valhalla:/usr/app/apps/valhalla:delegated
      - ./libs:/usr/app/libs:delegated

  # Databases
  db:
    build:
      context: images/postgres
    container_name: db
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: admin
    image: yggdrasil/db
    networks:
      - yggdrasil
      - midgard
    ports:
      - "5432:5432"

networks:
  yggdrasil:
    internal: true
    name: yggdrasil
  midgard:
    name: midgard
